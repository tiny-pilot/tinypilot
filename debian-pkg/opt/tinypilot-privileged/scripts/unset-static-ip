#!/bin/bash
#
# Reverts changes made by the set-static-ip script.
#
# The --quiet option suppresses the final confirmation and is for use with the
# set-static-ip script. It is intentionally excluded from the help text.

# Exit on first error.
set -e

print_help() {
  cat << EOF
Usage: ${0##*/} [--interface name]

Reverts changes made by the set-static-ip script.
  --interface name: (optional) The interface to configure. Defaults to eth0.
  --help: Display this help text.
EOF
}

# Use the same values as the previous script for compatibility.
readonly CONFIG_FILE="/etc/dhcpcd.conf"
readonly MARKER_START='# --- AUTOGENERATED BY TINYPILOT - START ---'
readonly MARKER_END='# --- AUTOGENERATED BY TINYPILOT - END ---'

# Parse command-line arguments.
if ! NEW_ARGS=$(getopt -q -o "" -l "quiet,interface:" -- "$@"); then
  print_help
  exit 1
fi

# Process command-line arguments.
eval set -- "${NEW_ARGS}"
while true; do
  case "$1" in
    --quiet)
      readonly QUIET="true"
      shift 1
      ;;
    --interface)
      if [[ -z "${INTERFACE}" ]] ; then
        readonly INTERFACE="$2"
      else
        echo "Only one interface should be provided." >&2
        exit 1
      fi
      shift 2
      ;;
    --)
      shift
      break
      ;;
  esac
done

# Default interface.
if [[ -z "${INTERFACE}" ]] ; then
  readonly INTERFACE="eth0"
fi

# Remove any existing auto-generated configuration for the interface.
dhcpcd_original=()
section=()
interface_matched="false"
while IFS= read -r line; do
  if [[ "${#section[@]}" -ne 0 ]] && [[ "${line}" == "${MARKER_END}" ]]; then
    section+=("${line}")
    if [[ "${interface_matched}" == "false" ]] ; then
      dhcpcd_original=("${dhcpcd_original[@]}" "${section[@]}")
    fi
    section=()
    interface_matched="false"
    continue
  fi
  if [[ "${#section[@]}" -ne 0 ]] || [[ "${line}" == "${MARKER_START}" ]]; then
    if [[ "${line}" == "interface ${INTERFACE}" ]] ; then
      interface_matched="true"
    fi
    section+=("${line}")
    continue
  fi
  dhcpcd_original+=("${line}")
done < "${CONFIG_FILE}"

if [[ "${#section[@]}" -ne 0 ]] ; then
  echo "Unclosed marker section." >&2
  exit 1
fi

# Convert array of lines to a single string.
readonly OLD_CONFIG_FILE=$(printf "%s\n" "${dhcpcd_original[@]}")

# Write original file contents back to the file.
echo "${OLD_CONFIG_FILE}" | sudo tee "${CONFIG_FILE}" > /dev/null

# Changes require a reboot so prompt the user.
if [[ -z "${QUIET}" ]] ; then
  echo "Any changes made by the set-static-ip script have been reverted."
  echo "  Interface: ${INTERFACE}"
  echo ""
  echo "Reboot your TinyPilot device to apply the changes."
fi
