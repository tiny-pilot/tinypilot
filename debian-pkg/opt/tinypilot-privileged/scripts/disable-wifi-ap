#!/bin/bash
#
# Disable TinyPilot WiFi access point.

# Exit on first failure.
set -e

# Echo commands before executing them, by default to stderr.
set -x

# Exit on unset variable.
set -u

if (( "${EUID}" != 0 )); then
  >&2 echo 'This script requires root privileges.'
  >&2 echo 'Please re-run with sudo:' >&2
  >&2 echo "  sudo $0 $*" >&2
  >&2 exit 1
fi

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
readonly SCRIPT_DIR
# shellcheck source=lib/markers.sh
. "${SCRIPT_DIR}/lib/markers.sh"

"${SCRIPT_DIR}/strip-marker-sections" /etc/dhcpcd.conf

mv \
  /etc/wpa_supplicant/wpa_supplicant.conf.bak \
  /etc/wpa_supplicant/wpa_supplicant.conf

if [[ -e /etc/wpa_supplicant/wlan_enabled ]]; then
  rm --force /etc/wpa_supplicant/wlan_enabled
else
  rfkill block wlan
fi

systemctl stop hostapd dnsmasq
rm --force /etc/hostapd/hostapd.conf
rm --force /etc/dnsmasq.conf
apt remove hostapd dnsmasq --yes
