<template id="debug-dialog-template">
  <style>
    @import "css/button.css";

    .overlay {
      display: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    :host([show="true"]) .overlay {
      display: block;
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 2;
    }

    #logs-loading,
    #logs-success,
    #logs-fail,
    #url-loading,
    #url-success,
    #url-fail {
      display: none;
    }

    :host([state="logs-loading"]) #logs-loading,
    :host([state="logs-success"]) #logs-success,
    :host([state="logs-fail"]) #logs-fail,
    :host([state="url-loading"]) #url-loading,
    :host([state="url-success"]) #url-success,
    :host([state="url-fail"]) #url-fail {
      display: block;
    }

    #panel > div {
      background-color: rgb(252, 236, 223);
      border: 1px solid rgb(139, 97, 62);
      max-width: 800px;
      margin: 100px auto 0rem auto;
      padding: 2rem;
    }

    #logs-success .logs {
      font-family: consolas, monospace;
      background-color: #F1F1F1;
      user-select: text;
      text-align: left;
      overflow-y: scroll;
      max-height: 500px;
      white-space: pre-wrap;
    }

    #url-success .url {
      font-family: consolas, monospace;
      background-color: #F1F1F1;
      user-select: text;
      padding: 1rem 2rem;
    }

    .error {
      color: rgb(153, 8, 8);
      user-select: text;
      white-space: pre-wrap;
    }
  </style>
  <div id="panel" class="overlay">
    <!-- Get Debug Logs -->
    <div id="logs-loading">
      <h3>Retrieving debug logs</h3>
      <progress-spinner></progress-spinner>
    </div>
    <div id="logs-success">
      <h3>Debug Logs</h3>
      <p class="logs"></p>
      <button class="share-btn btn-success" type="button">
        Get shareable URL
      </button>
      <button class="copy-btn btn-success" type="button">
        Copy to clipboard
      </button>
      <button class="close-btn" type="button">Close</button>
    </div>
    <div id="logs-fail">
      <h3>Error retrieving debug logs</h3>
      <p class="error"></p>
      <button class="close-btn" type="button">Close</button>
    </div>
    <!-- Get Shareable URL -->
    <div id="url-loading">
      <h3>Retrieving shareable URL</h3>
      <progress-spinner></progress-spinner>
    </div>
    <div id="url-success">
      <h3>Shareable URL</h3>
      <p class="url"></p>
      <button class="copy-btn btn-success" type="button">
        Copy to clipboard
      </button>
      <button class="close-btn" type="button">Close</button>
    </div>
    <div id="url-fail">
      <h3>Error retrieving shareable URL</h3>
      <p class="error"></p>
      <button class="close-btn" type="button">Close</button>
    </div>
  </div>
</template>

<script>
  (function () {
    const doc = (document._currentScript || document.currentScript)
      .ownerDocument;
    const template = doc.querySelector('#debug-dialog-template');
    customElements.define(
      'debug-dialog',
      class DebugDialog extends HTMLElement {
        constructor() {
          super();
          this.attachShadow({ mode: 'open' });
          // Ensure that these methods always refer to the correct "this",
          // regardless of where they are called.
          this.close = this.close.bind(this);
          this.reset = this.reset.bind(this);
          this.getLogs = this.getLogs.bind(this);
          this.getURL = this.getURL.bind(this);
          this._watchKeyboard = this._watchKeyboard.bind(this);
        }

        connectedCallback() {
          this.shadowRoot.appendChild(template.content.cloneNode(true));
          this.shadowRoot.querySelector('.overlay')
            .addEventListener('click', this.close);
          this.shadowRoot.querySelectorAll('.close-btn').forEach((el) => {
            el.addEventListener('click', this.close);
          });
          this.shadowRoot.querySelector('#logs-success .share-btn')
            .addEventListener('click', this.getURL);
          doc.addEventListener('keydown', this._watchKeyboard);
        }

        disconnectedCallback() {
          doc.removeEventListener('keydown', this._watchKeyboard);
        }

        get show() {
          return this.getAttribute('show') === 'true';
        }

        set show(newValue) {
          this.setAttribute('show', newValue);
        }

        get state() {
          return this.getAttribute('state');
        }

        set state(newValue) {
          this.setAttribute('state', newValue);
        }

        _watchKeyboard(event) {
          // Prevent keystrokes from being sent to TinyPilot
          if (this.show) {
            event.stopImmediatePropagation();
          }
        }

        close(event) {
          // Only close the dialog when the element that triggered the
          // event (i.e. event.target) is the same as the element that the
          // event listener is attached to (i.e. event.currentTarget).
          // Source: https://stackoverflow.com/a/53815609/3769045
          if (event.target !== event.currentTarget) {
            return;
          }
          this.show = false;
          this.reset();
        }

        reset() {
          this.state = null;
        }

        getLogs() {
          this.state = 'logs-loading';
          controllers.getDebugLogs()
            .then(text => {
              this.shadowRoot.querySelector('#logs-success .logs')
                .textContent = text;
              this.state = 'logs-success';
            })
            .catch(error => {
              this.shadowRoot.querySelector('#logs-fail .error')
                .textContent = error;
              this.state = 'logs-fail';
            });
        }

        getURL() {
          this.state = 'url-loading';
          const text = this.shadowRoot.querySelector('#logs-success .logs')
            .textContent;
          controllers.textToShareableURL(text)
            .then(url => {
              this.shadowRoot.querySelector('#url-success .url')
                .textContent = url;
              this.state = 'url-success';
            })
            .catch(error => {
              this.shadowRoot.querySelector('#url-fail .error')
                .textContent = error;
              this.state = 'url-fail';
            });
        }
      }
    )
  })();
</script>
