<template id="debug-dialog-template">
  <style>
    @import "css/style.css";
    @import "css/button.css";

    #logs-loading,
    #logs-success,
    #url-loading,
    #url-success {
      display: none;
    }

    :host([state="logs-loading"]) #logs-loading,
    :host([state="logs-success"]) #logs-success,
    :host([state="url-loading"]) #url-loading,
    :host([state="url-success"]) #url-success {
      display: block;
    }

    .action-buttons {
      text-align: left;
    }

    .action-buttons button {
      margin: 0 1rem 0 0;
    }

    #logs-success .logs {
      max-height: 600px;
    }

    #url-success .url-wrapper {
      margin: 1rem 0;
    }

    #url-success .url {
      user-select: text;
      background: #bdbdbd;
      padding: 0.6rem 2rem;
      border-radius: var(--border-radius);
    }
  </style>

  <!-- Get Debug Logs -->
  <div id="logs-loading">
    <h3>Retrieving Debug Logs</h3>
    <progress-spinner></progress-spinner>
  </div>

  <div id="logs-success">
    <h3>Debug Logs</h3>
    <div class="action-buttons">
      <button class="share-btn btn-action" type="button">
        Get Shareable URL
      </button>
      <button class="copy-btn btn-action" type="button">
        Copy to Clipboard
      </button>
    </div>
    <p class="logs logs-output monospace"></p>
    <button class="close-btn" type="button">Close</button>
  </div>

  <!-- Get Shareable URL -->
  <div id="url-loading">
    <h3>Retrieving Shareable URL</h3>
    <progress-spinner></progress-spinner>
  </div>

  <div id="url-success">
    <h3>Debug Logs</h3>
    <div class="url-wrapper">
      <a class="url"></a>
      <button class="copy-btn btn-action" type="button">
        Copy to Clipboard
      </button>
    </div>
    <button class="close-btn" type="button">Close</button>
  </div>
</template>

<script type="module">
  import { DialogClosedEvent, DialogFailedEvent } from "/js/events.js";
  import { copyElementTextToClipboard } from "/js/clipboard.js";
  import { getDebugLogs, textToShareableUrl } from "/js/controllers.js";

  (function () {
    const template = document.querySelector("#debug-dialog-template");
    customElements.define(
      "debug-dialog",
      class DebugDialog extends HTMLElement {
        constructor() {
          super();
          this.attachShadow({ mode: "open" });
          // Ensure that these methods always refer to the correct "this",
          // regardless of where they are called.
          this.getLogs = this.getLogs.bind(this);
          this._getUrl = this._getUrl.bind(this);
        }

        connectedCallback() {
          this.shadowRoot.appendChild(template.content.cloneNode(true));
          this.shadowRoot.querySelectorAll(".close-btn").forEach((el) => {
            el.addEventListener("click", () =>
              this.dispatchEvent(new DialogClosedEvent())
            );
          });
          this.shadowRoot
            .querySelector("#logs-success .share-btn")
            .addEventListener("click", this._getUrl);
          this.shadowRoot
            .querySelector("#logs-success .copy-btn")
            .addEventListener("click", (event) => {
              this.onPushCopyButton(
                /*buttonElement=*/ event.target,
                /*sourceElement=*/ this.shadowRoot.querySelector(
                  "#logs-success .logs"
                )
              );
            });
          this.shadowRoot
            .querySelector("#url-success .copy-btn")
            .addEventListener("click", (event) => {
              this.onPushCopyButton(
                /*buttonElement=*/ event.target,
                /*sourceElement=*/ this.shadowRoot.querySelector(
                  "#url-success .url"
                )
              );
            });
        }

        get state() {
          return this.getAttribute("state");
        }

        set state(newValue) {
          this.setAttribute("state", newValue);
        }

        getLogs() {
          this.state = "logs-loading";
          getDebugLogs()
            .then((text) => {
              this.shadowRoot.querySelector(
                "#logs-success .logs"
              ).textContent = text;
              this.state = "logs-success";
            })
            .catch((error) => {
              this.dispatchEvent(
                new DialogFailedEvent({
                  title: "Error Retrieving Debug Logs",
                  details: error,
                })
              );
            });
        }

        _getUrl() {
          this.state = "url-loading";
          const text = this.shadowRoot.querySelector("#logs-success .logs")
            .textContent;
          textToShareableUrl(text)
            .then((url) => {
              const urlElement = this.shadowRoot.querySelector(
                "#url-success .url"
              );
              urlElement.textContent = url;
              urlElement.href = url;
              this.state = "url-success";
            })
            .catch((error) => {
              this.dispatchEvent(
                new DialogFailedEvent({
                  title: "Error Retrieving Shareable URL",
                  details: error,
                })
              );
            });
        }

        onPushCopyButton(buttonElement, sourceElement) {
          copyElementTextToClipboard(sourceElement);
          buttonElement.innerText = "Copied!";
        }
      }
    );
  })();
</script>
