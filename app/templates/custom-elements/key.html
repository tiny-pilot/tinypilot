<template id="key-template">
  <style>
    .key {
      position: relative;
      display: block;
      float: left;
      width: 50px;
      height: 50px;
      font-size: 12px;
      background-color: #fff;
      line-height: 16px;
      border-radius: 2px;
      margin: 1px;
      cursor: pointer;
      border: 0 solid #fff;
      text-align: left;
      outline: 0px solid #333333;
      transition: background-color 0.25s;
    }

    .key:hover {
      background-color: #e3e3e3;
    }

    .key:active {
      background-color: #8f8f8f;
    }

    .key.key-pressed {
      outline: 1px solid #333333;
      background-color: #8f8f8f;
    }

    .key .content-top {
      position: absolute;
      top: 5px;
      left: 5px;
    }

    .key .content-bottom {
      position: absolute;
      bottom: 5px;
      left: 5px;
    }

    .hidden {
      visibility: hidden;
    }

    .key.key-collapse-half {
      width: 24px;
    }

    .key.key-extend-half {
      width: 77px;
    }

    .key.key-extend-full {
      width: 102px;
    }

    .key.key-extend-full-half {
      width: 128px;
    }

    .key.key-space {
      width: 229px;
    }


  </style>
  <button id="key-button" type="button" class="key">
    <span id="key-content-top" class="content-top">
      <!-- default slot -->
      <slot></slot>
    </span>
    <span id="key-content-bottom" class="content-bottom">
      <slot name="bottom"></slot>
    </span>
  </button>
</template>

<script>
  (function () {
    const doc = (document._currentScript || document.currentScript)
      .ownerDocument;
    const template = doc.querySelector("#key-template");



    customElements.define(
      "tp-key",
      class extends HTMLElement {
        constructor() {
          super();
          this.addEventListener("click", (e) => {
            e.preventDefault();

            if (this.getAttribute("modifier") == "true" && this.pressed) {
              this.togglePressedState()
            } else {
              this.processClick();
            }
          });
        }

        connectedCallback() {
          this.attachShadow({ mode: "open" });
          const instance = template.content.cloneNode(true);

          // if special css classes passed for button, add them
          if (this.getAttribute('button-class')){
            const childClasses = this.getAttribute('button-class')
            const button = instance.querySelector('#key-button')
            childClasses.split(' ').forEach(cls => {
              button.classList.add(cls);
            })
          }

          this.shadowRoot.appendChild(instance);

        }

        get pressed() {
          return this.getAttribute("pressed") === "true";
        }

        set pressed(newValue) {
          // only modifier keys can be "pressed"
          if (this.getAttribute("modifier") == "true") {
            this.setAttribute("pressed", newValue);
            this.setKeyPressedClass(newValue);
          }
        }

        processClick(){
          this.togglePressedState();

          const location = (this.getAttribute("location")) ? this.getAttribute("location") : null;
          let keyChar = 'undefined';
          const thisChildren = Array.from(this.childNodes)

          // get value of this key
          if (thisChildren.length == 1){
            keyChar = (thisChildren[0].constructor.name == 'Text') ?
              thisChildren[0].data : 0;
          } else if (thisChildren.length > 1) {
            // if key has multiple characters, return the bottom character
            // (meaning the one you get without shift, its processed in key-click event)
            const bottomSlot = thisChildren.find(c => c.constructor.name == 'HTMLSpanElement');
            keyChar = (bottomSlot.firstChild.constructor.name == 'Text') ?
              bottomSlot.firstChild.data : 0;
          }

          this.dispatchEvent(
            new CustomEvent("key-click", {
              detail: {
                keyChar: keyChar.replace(' ',''),
                location: location,
                isModifier: this.getAttribute("modifier") === "true"
              },
              bubbles: true,
              composed: true,
            })
          );
        }

        togglePressedState() {
          this.pressed = !this.pressed;
        }

        setKeyPressedClass(newValue) {
          // add or remove css class to indicate whether key is pressed
          const buttonCls = this.shadowRoot.querySelector('#key-button').classList;
          if(newValue == true || newValue == 'true'){
            buttonCls.add('key-pressed');
          } else {
            buttonCls.remove('key-pressed');
          }
        }
      }
    );
  })();
</script>
