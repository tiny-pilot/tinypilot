<template id="about-dialog-template">
  <style>
    @import "css/style.css";
    @import "css/button.css";

    :host {
      text-align: left;
    }

    :host > *:not(button) {
      padding: 0 4rem;
    }

    #version-number {
      overflow: hidden;
      white-space: nowrap;
    }

    .credits-container {
      overflow-y: scroll;
      max-height: 300px;
    }

    credit-box {
      margin: 0.5rem 0;
    }

    ul {
      margin-top: 0;
      columns: 3;
      padding-left: 1rem;
    }
  </style>

  <h3 style="text-align: center;">About TinyPilot</h3>
  <p>
    <strong>Version:</strong> <span id="version-number" class="monospace"></span
    ><br />
    <strong>Website:</strong>
    <a href="https://tinypilotkvm.com" target="_blank"
      >https://tinypilotkvm.com</a
    ><br />
    <strong>License:</strong>
    <a href="/py-license/tinypilot" target="_blank">MIT license</a>
  </p>

  <div class="credits-container">
    <p>
      TinyPilot would not be possible without the help of these open-source
      projects:
    </p>
    <ul class="credits"></ul>
  </div>

  <button class="close-btn" type="button">Close</button>
</template>

<script type="module">
  import { DialogClosedEvent, DialogFailedEvent } from "/js/events.js";
  import { getVersion } from "/js/controllers.js";

  (function () {
    const template = document.querySelector("#about-dialog-template");

    customElements.define(
      "about-dialog",
      class extends HTMLElement {
        connectedCallback() {
          this.attachShadow({ mode: "open" }).appendChild(
            template.content.cloneNode(true)
          );
          this.shadowRoot
            .querySelector(".close-btn")
            .addEventListener("click", () =>
              this.dispatchEvent(new DialogClosedEvent())
            );

          // We're doing this at page load time rather than dialog load time,
          // but that should be fine, as we don't expect the version to change
          // without a page reload.
          this._checkVersion();

          // Hack to fix init order issue, by arbitrarily deferring the rendering.
          setTimeout(() => this._populateCredits(), 500);
        }

        _checkVersion() {
          getVersion()
            .then((version) => {
              this.shadowRoot.getElementById(
                "version-number"
              ).innerText = this._formatVersion(version);
            })
            .catch((error) => {
              this.dispatchEvent(
                new DialogFailedEvent({
                  title: "Failed to Retrieve Version Information",
                  details: error,
                })
              );
            });
        }

        _populateCredits() {
          // For code where the source or license is on the local device, prefer
          // linking to the locally-available copy instead of the remote URL so
          // that the license ties tightly to the version we're using. When
          // that's not possible, look for permalink versions of the license
          // that match what we're using.
          const creditedProjects = {
            uStreamer: {
              homepage: "https://github.com/pikvm/ustreamer",
            },
            nginx: {
              homepage: "https://nginx.org",
            },
            Ansible: {
              homepage: "https://www.ansible.com",
            },
            Python: {
              homepage: "https://python.org",
            },
            Janus: {
              homepage: "https://janus.conf.meetecho.com",
            },
            // JavaScript dependencies.
            "webrtc-adapter": {
              homepage: "https://github.com/webrtcHacks/adapter",
            },
            "socket.io": {
              homepage: "https://socket.io",
            },
            // Python dependencies.
            eventlet: {
              homepage: "https://eventlet.net",
            },
            Flask: {
              homepage: "https://flask.palletsprojects.com",
            },
            "Flask-SocketIO": {
              homepage: "https://flask-socketio.readthedocs.io",
            },
            "Flask-WTF": {
              homepage: "https://flask-wtf.readthedocs.io",
            },
            pyyaml: {
              homepage: "https://pyyaml.org",
            },
            bidict: {
              homepage: "https://bidict.readthedocs.io/en/main",
            },
            click: {
              license: "/license/click",
              homepage: "https://palletsprojects.com/p/click",
            },
            dnspython: {
              homepage: "https://www.dnspython.org",
            },
            greenlet: {
              homepage: "https://greenlet.readthedocs.io",
            },
            itsdangerous: {
              homepage: "https://palletsprojects.com/p/itsdangerous/",
            },
            Jinja2: {
              homepage: "https://palletsprojects.com/p/jinja/",
            },
            MarkupSafe: {
              homepage: "https://palletsprojects.com/p/markupsafe/",
            },
            monotonic: {
              homepage: "https://github.com/atdt/monotonic",
            },
            "python-engineio": {
              homepage: "https://github.com/miguelgrinberg/python-engineio",
            },
            "python-socketio": {
              homepage: "https://github.com/miguelgrinberg/python-socketio",
            },
            six: {
              homepage: "https://github.com/benjaminp/six",
            },
            Werkzeug: {
              homepage: "https://palletsprojects.com/p/werkzeug/",
            },
            WTForms: {
              homepage: "https://wtforms.readthedocs.io",
            },
            // Indirect dependencies through Janus.
            libnice: {
              homepage: "https://gitlab.freedesktop.org/libnice/libnice",
            },
            librtsp: {
              homepage: "https://libwebsockets.org",
            },
            Overpass: {
              homepage: "https://overpassfont.org/",
            },
          };
          const creditsDiv = this.shadowRoot.querySelector(".credits");
          for (const [projectName, props] of Object.entries(creditedProjects)) {
            const credit = document.createElement("credit-box");
            creditsDiv.appendChild(credit);
            credit.title = projectName;
            credit.licenseUrl = `/projects/${projectName}/license`;
            credit.homepageUrl = props.homepage;
          }
        }

        _formatVersion(version) {
          // Truncate git version hash.
          return version.substr(0, 6);
        }
      }
    );
  })();
</script>
