<template id="about-dialog-template">
  <style>
    @import "css/style.css";
    @import "css/button.css";

    #version-number {
      font-size: 1rem 0;
      overflow: hidden;
      white-space: nowrap;
    }

    .credits {
      text-align: left;
      max-height: 300px;
      overflow: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }

    credit-box {
      margin: 0.5rem 0;
    }
  </style>

  <h3>About TinyPilot</h3>
  <p>TinyPilot version <span id="version-number" class="monospace"></span></p>
  <p>
    <a href="https://tinypilotkvm.com" target="_blank"
      >https://tinypilotkvm.com</a
    >
  </p>
  <p>
    TinyPilot is released under the
    <a href="/py-license/tinypilot" target="_blank">MIT license</a>.
  </p>
  <div class="credits">
    <p>
      TinyPilot would not be possible without the help of these open-source
      projects:
    </p>
  </div>

  <button class="close-btn" type="button">Close</button>
</template>

<script type="module">
  import { DialogClosedEvent, DialogFailedEvent } from "/js/events.js";
  import { getVersion } from "/js/controllers.js";

  (function () {
    const template = document.querySelector("#about-dialog-template");

    // For code where the source or license is on the local device, prefer
    // linking to the locally-available copy instead of the remote URL so that
    // the license ties tightly to the version we're using. When that's not
    // possible look for permalink versions of the license that match what we're
    // using.
    const creditedProjects = {
      uStreamer: {
        license:
          "https://raw.githubusercontent.com/tiny-pilot/ustreamer/v4.13/LICENSE",
        homepage: "https://github.com/pikvm/ustreamer",
      },
      nginx: {
        license: "https://nginx.org/LICENSE",
        homepage: "https://nginx.org",
      },
      Ansible: {
        license:
          "https://raw.githubusercontent.com/ansible/ansible/v2.9.10/COPYING",
        homepage: "https://www.ansible.com",
      },
      Python: {
        license: "/py-license/python",
        homepage: "https://python.org",
      },
      Janus: {
        license:
          "https://raw.githubusercontent.com/tiny-pilot/janus-gateway/v1.0.0/COPYING",
        homepage: "https://janus.conf.meetecho.com",
      },
      // JavaScript dependencies.
      "webrtc-adapter": {
        license:
          "https://github.com/webrtcHacks/adapter/blob/18a8b4127cbc1376320cac5742d817b5b7dd0085/LICENSE.md",
        homepage: "https://github.com/webrtcHacks/adapter",
      },
      "socket.io": {
        license: "https://github.com/socketio/socket.io/blob/3.1.2/LICENSE",
        homepage: "https://socket.io",
      },
      // Python dependencies.
      eventlet: {
        license: "/py-license/eventlet",
        homepage: "https://eventlet.net",
      },
      Flask: {
        license: "/py-license/flask",
        homepage: "https://flask.palletsprojects.com",
      },
      "Flask-SocketIO": {
        license: "/py-license/flask-socketio",
        homepage: "https://flask-socketio.readthedocs.io",
      },
      "Flask-WTF": {
        license: "/py-license/Flask-WTF",
        homepage: "https://flask-wtf.readthedocs.io",
      },
      pyyaml: {
        license: "https://raw.githubusercontent.com/yaml/pyyaml/5.4.1/LICENSE",
        homepage: "https://pyyaml.org",
      },
      bidict: {
        license: "/py-license/bidict",
        homepage: "https://bidict.readthedocs.io/en/main",
      },
      click: {
        license: "/py-license/click",
        homepage: "https://palletsprojects.com/p/click",
      },
      dnspython: {
        license: "/py-license/dnspython",
        homepage: "https://www.dnspython.org",
      },
      greenlet: {
        license: "/py-license/greenlet",
        homepage: "https://greenlet.readthedocs.io",
      },
      itsdangerous: {
        license: "/py-license/itsdangerous",
        homepage: "https://palletsprojects.com/p/itsdangerous/",
      },
      Jinja2: {
        license: "/py-license/Jinja2",
        homepage: "https://palletsprojects.com/p/jinja/",
      },
      MarkupSafe: {
        license: "/py-license/MarkupSafe",
        homepage: "https://palletsprojects.com/p/markupsafe/",
      },
      monotonic: {
        license: "https://raw.githubusercontent.com/atdt/monotonic/1.5/LICENSE",
        homepage: "https://github.com/atdt/monotonic",
      },
      "python-engineio": {
        license: "/py-license/python-engineio",
        homepage: "https://github.com/miguelgrinberg/python-engineio",
      },
      "python-socketio": {
        license: "/py-license/python-socketio",
        homepage: "https://github.com/miguelgrinberg/python-socketio",
      },
      six: {
        license: "/py-license/six",
        homepage: "https://github.com/benjaminp/six",
      },
      Werkzeug: {
        license: "/py-license/Werkzeug",
        homepage: "https://palletsprojects.com/p/werkzeug/",
      },
      WTForms: {
        license: "/py-license/WTForms",
        homepage: "https://wtforms.readthedocs.io",
      },
      // Indirect dependencies through Janus.
      libnice: {
        license:
          "https://gitlab.freedesktop.org/libnice/libnice/-/blob/0.1.18/COPYING",
        homepage: "https://gitlab.freedesktop.org/libnice/libnice",
      },
      librtsp: {
        license:
          "https://libwebsockets.org/git/libwebsockets/tree/LICENSE?h=v3.2-stable",
        homepage: "https://libwebsockets.org",
      },
    };

    customElements.define(
      "about-dialog",
      class extends HTMLElement {
        connectedCallback() {
          this.attachShadow({ mode: "open" }).appendChild(
            template.content.cloneNode(true)
          );
          this.shadowRoot
            .querySelector(".close-btn")
            .addEventListener("click", () =>
              this.dispatchEvent(new DialogClosedEvent())
            );

          // We're doing this at page load time rather than dialog load time,
          // but that should be fine, as we don't expect the version to change
          // without a page reload.
          this._checkVersion();

          this._populateCredits();
        }

        _checkVersion() {
          getVersion()
            .then((version) => {
              this.shadowRoot.getElementById(
                "version-number"
              ).innerText = this._formatVersion(version);
            })
            .catch((error) => {
              this.dispatchEvent(
                new DialogFailedEvent({
                  title: "Failed to Retrieve Version Information",
                  details: error,
                })
              );
            });
        }

        _populateCredits() {
          const creditsDiv = this.shadowRoot.querySelector(".credits");
          for (const [projectName, props] of Object.entries(creditedProjects)) {
            const credit = document.createElement("credit-box");
            creditsDiv.appendChild(credit);
            credit.title = projectName;
            credit.licenseUrl = props.license;
            credit.homepageUrl = props.homepage;
          }
        }

        _formatVersion(version) {
          // Truncate git version hash.
          return version.substr(0, 6);
        }
      }
    );
  })();
</script>
