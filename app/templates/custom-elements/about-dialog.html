<template id="about-dialog-template">
  <style>
    @import "css/style.css";
    @import "css/button.css";

    #version-number {
      font-size: 1rem;
      overflow: hidden;
      white-space: nowrap;
    }

    .credits {
      text-align: left;
      max-height: 300px;
      overflow: auto;
    }

    .project {
      background-color: lightgreen;
      display: flex;
      flex-direction: row;
      padding: 0.25rem 0.5rem;
    }

    .project + .project {
      margin: 1rem 0;
    }

    .project .title {
      font-weight: bold;
    }

    .project .links {
      margin-left: auto;
    }

    .project .separator {
      margin: 0 0.5rem;
    }
  </style>

  <h3>About TinyPilot</h3>
  <p>TinyPilot version <span id="version-number" class="monospace"></span></p>
  <p>
    <a href="https://tinypilotkvm.com" target="_blank"
      >https://tinypilotkvm.com</a
    >
  </p>
  <p>
    TinyPilot is released under the
    <a href="/py-license/tinypilot" target="_blank">MIT license</a>.
  </p>
  <div class="credits">
    <p>
      TinyPilot would not be possible without the help of these open-source
      projects:
    </p>
  </div>

  <button class="close-btn" type="button">Close</button>
</template>

<script type="module">
  import { DialogClosedEvent, DialogFailedEvent } from "/js/events.js";
  import { getVersion } from "/js/controllers.js";

  (function () {
    const template = document.querySelector("#about-dialog-template");

    // TODO: for each project, include a link to license and homepage
    // TODO: add routes in Flask to each Python project's license in ./venv
    // TODO: add routes in nginx to each non-Python project's license
    // TODO: Add the indirect projects we get through Janus
    const creditedProjects = {
      uStreamer: {
        license:
          "https://raw.githubusercontent.com/tiny-pilot/ustreamer/v4.13/LICENSE",
        homepage: "https://github.com/pikvm/ustreamer",
      },
      nginx: {
        license: "https://nginx.org/LICENSE",
        homepage: "https://nginx.org",
      },
      Ansible: {
        license:
          "https://raw.githubusercontent.com/ansible/ansible/v2.9.10/COPYING",
        homepage: "https://www.ansible.com/",
      },
      Python: {
        license: "/py-license/python",
        homepage: "https://python.org",
      },
      Janus: {
        license:
          "https://raw.githubusercontent.com/tiny-pilot/janus-gateway/v1.0.0/COPYING",
        homepage: "https://janus.conf.meetecho.com/",
      },
      "webrtc-adapter": {},
      "socket.io": {},
      eventlet: {},
      Flask: {
        license: "/py-license/flask",
        homepage: "https://flask.palletsprojects.com/",
      },
      "Flask-SocketIO": {
        license: "/py-license/flask-socketio",
        homepage: "https://flask-socketio.readthedocs.io/",
      },
      "Flask-WTF": { license: "/py-license/Flask-WTF", homepage: "" },
      pyyaml: { license: "/py-license/pyyaml", homepage: "" },
      bidict: { license: "/py-license/bidict", homepage: "" },
      click: { license: "/py-license/click", homepage: "" },
      dnspython: { license: "/py-license/dnspython", homepage: "" },
      greenlet: { license: "/py-license/greenlet", homepage: "" },
      itsdangerous: { license: "/py-license/itsdangerous", homepage: "" },
      Jinja2: { license: "/py-license/Jinja2", homepage: "" },
      MarkupSafe: { license: "/py-license/MarkupSafe", homepage: "" },
      "python-engineio": {
        license: "/py-license/python-engineio",
        homepage: "",
      },
      "python-socketio": {
        license: "/py-license/python-socketio",
        homepage: "",
      },
      six: { license: "/py-license/six", homepage: "" },
      Werkzeug: { license: "/py-license/Werkzeug", homepage: "" },
      WTForms: { license: "/py-license/WTForms", homepage: "" },
    };

    customElements.define(
      "about-dialog",
      class extends HTMLElement {
        connectedCallback() {
          this.attachShadow({ mode: "open" }).appendChild(
            template.content.cloneNode(true)
          );
          this.shadowRoot
            .querySelector(".close-btn")
            .addEventListener("click", () =>
              this.dispatchEvent(new DialogClosedEvent())
            );

          // We're doing this at page load time rather than dialog load time,
          // but that should be fine, as we don't expect the version to change
          // without a page reload.
          this._checkVersion();

          this._populateCredits();
        }

        _checkVersion() {
          getVersion()
            .then((version) => {
              this.shadowRoot.getElementById(
                "version-number"
              ).innerText = this._formatVersion(version);
            })
            .catch((error) => {
              this.dispatchEvent(
                new DialogFailedEvent({
                  title: "Failed to Retrieve Version Information",
                  details: error,
                })
              );
            });
        }

        _populateCredits() {
          const creditsDiv = this.shadowRoot.querySelector(".credits");
          for (const [projectName, props] of Object.entries(creditedProjects)) {
            const projectDiv = document.createElement("div");
            projectDiv.className = "project";

            const titleSpan = document.createElement("span");
            titleSpan.className = "title";
            titleSpan.innerText = projectName;
            projectDiv.appendChild(titleSpan);

            const linksDiv = document.createElement("div");
            linksDiv.className = "links";
            projectDiv.appendChild(linksDiv);

            const licenseLink = document.createElement("a");
            licenseLink.className = "license";
            licenseLink.innerText = "License";
            licenseLink.href = props.license;
            licenseLink.target = "_blank";
            linksDiv.appendChild(licenseLink);

            const separatorSpan = document.createElement("span");
            separatorSpan.className = "separator";
            separatorSpan.innerText = "â€¢";
            linksDiv.appendChild(separatorSpan);

            const homepageLink = document.createElement("a");
            homepageLink.className = "homepage";
            homepageLink.innerText = "Homepage";
            homepageLink.href = props.homepage;
            homepageLink.target = "_blank";
            linksDiv.appendChild(homepageLink);

            creditsDiv.appendChild(projectDiv);
          }
        }

        _formatVersion(version) {
          // Truncate git version hash.
          return version.substr(0, 6);
        }
      }
    );
  })();
</script>
